# Attestation Overview

Attestation is a security mechanism that allows a client to **verify the identity and integrity of a remote system before sending sensitive data**.

In the context of confidential computing, attestation provides cryptographic proof that an application is running:

* Inside a **Trusted Execution Environment (TEE)**
* With **expected software and configuration**
* Without interference from the host operating system, hypervisor, or cloud provider

Attestation is a foundational building block for **zero-trust architectures**, where trust is never assumed and must always be verified.

For Cube AI, attestation ensures that sensitive prompts, embeddings, and responses are processed only by trusted and verified AI services.

---

## Attestation and Attested TLS (aTLS)

To allow clients to send confidential data to Cube AI securely, a secure channel based on **Attested TLS (aTLS)** is established.

aTLS is a standard TLS connection augmented with a **hardware-backed attestation report** proving that the remote service is running inside a **Trusted Execution Environment (TEE)**.

In Cube AI, the agent service running inside the TEE acts as the TLS server and extends its X.509 certificate with an attestation report generated by the underlying TEE (e.g. AMD SEV-SNP).

When generating the attestation report, the service embeds the **hash of its ephemeral public key** into the `report_data` field of the attestation report.

A new TLS certificate and a fresh attestation report are generated for every connection, ensuring cryptographic freshness and preventing replay attacks.

This provides cryptographic proof that the client is communicating directly with the Cube AI service running inside a TEE, and not with the host system or any intermediary.

---

## Proxy-Based Attestation

Unlike systems where users must manually perform attestation using a CLI tool, Cube AI automates the attestation process through a **proxy component deployed in the Cube AI infrastructure**.

The Cube AI Proxy:

* Forwards client connections to Cube AI services secured with **aTLS**
* Fetches and exposes attestation evidence associated with the aTLS-secured service endpoint
* Ensures that the TLS key is cryptographically bound to the attested TEE
* Provides auditability through structured logs and attestation records
* Transparently forwards client requests and responses

From the user's perspective, the client application communicates with Cube AI services over **standard HTTPS**.  
Attestation evidence can be retrieved directly through the proxy, while aTLS verification results are recorded in structured audit logs, without requiring any client-side deployment or manual verification steps.

---

## Attestation Policy Verification

The Local Proxy enforces an **attestation policy** that defines the expected properties of the TEE.

This policy includes:

* Reference values for fields in the attestation report
* Expected measurements identifying the Cube AI service running inside the TEE
* Verification that the TLS key is bound to the attested enclave

![Event details](img/eventdetails.png)

Only if the attestation report satisfies the policy will the Proxy establish and maintain the aTLS connection.

---

## aTLS Verification and Audit Logs

Each successful aTLS handshake is recorded by the Cube AI Proxy in structured audit logs.  
These audit log entries provide verifiable evidence that the connection was established with a TEE-backed Cube AI service and that attestation policy verification succeeded.

![aTLS handshake audit log](img/atls-audit-log.png)

Through these logs, users can audit completed aTLS handshakes and verify that no connections were established without successful attestation.

## Security Guarantees

This design ensures that:

*   Plaintext input is visible only inside the TEE
*   Sensitive data and AI workloads are processed exclusively within the enclave
*   The host OS, hypervisor, and cloud provider cannot access user data
*   No manual attestation steps are required from users
*   The client can trust the identity and integrity of the remote service
